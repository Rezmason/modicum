<script src="./lib/webgl-debug.js"></script>
<script type="module">

  import Modicum from "./js/modicum.js";

  document.body.onload = async () => {
    const modicum = new Modicum(null, {
      debugger: gl => WebGLDebugUtils.makeDebugContext(gl, null, (name, args) => console.log(`${name} (${[...args]})`))
    });
    await modicum.installTextures();
    modicum.canvas.width = 256;
    modicum.canvas.height = 256;
    modicum.resize(256, 256);
    document.body.appendChild(modicum.canvas);

    const program = modicum.makeProgram(
      `
      attribute vec2 aUV;
      varying vec2 vUV;
      void main() {
        vUV = aUV;
        gl_Position = vec4((aUV - 1.), 0., 1.);
      }
      `,
      `
      precision mediump float;
      varying vec2 vUV;
      uniform sampler2D uSampler;
      void main() {
       gl_FragColor = texture2D(uSampler, vUV);
      }
      `
    );

    const redTexture = (await modicum.makeTexture(1, 1, [1, 0, 0, 1], {isFloat: true})).update();
    const mesh = program.makeMesh(4, 2)
      .setVertex(0, { aUV: [0, 0, 1, 0, 0, 1, 1, 1]})
      .setIndex(0, [0, 1, 2, 2, 1, 3])
      .update();

    const target = await modicum.makeTarget(256, 256, { isFloat: true, smooth: true });
    modicum.clear({r: 1, g: 1, b: 0, a: 1}, false, target);
    program.activate(target);
    program.drawMesh(mesh.setUniforms({ uSampler: redTexture }));
    program.deactivate();

    modicum.clear({r: 0, g: 1, b: 0, a: 1});
    program.activate();
    program.drawMesh(mesh.setUniforms({ uSampler: target.colorTexture }));
    program.deactivate();
  };
</script>
